<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>留言板 | NSOI</title>
    <link rel="icon" href="https://mr-onion-blog.fun/img/avatar.png" type="image/png">
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        .container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 1.5rem;
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .message-card {
            background-color: #f9fafb;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column; /* Changed to column to stack content and replies */
            justify-content: space-between;
            align-items: flex-start;
        }
        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            width: 100%;
            margin-bottom: 0.5rem;
        }
        .message-content-main {
            flex-grow: 1;
            width: 100%;
        }
        .admin-controls {
            flex-shrink: 0;
            margin-left: 1rem;
        }
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s ease-in-out;
        }
        .btn-primary {
            background-color: #4f46e5;
            color: white;
        }
        .btn-primary:hover {
            background-color: #4338ca;
        }
        .btn-danger {
            background-color: #ef4444;
            color: white;
        }
        .btn-danger:hover {
            background-color: #dc2626;
        }
        .btn-secondary {
            background-color: #6b7280;
            color: white;
        }
        .btn-secondary:hover {
            background-color: #4b5563;
        }
        .input-field {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            box-sizing: border-box;
        }
        textarea.input-field {
            min-height: 100px;
            resize: vertical;
        }
        .replies-container {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb;
            width: 100%;
        }
        .reply-card {
            background-color: #eff6ff; /* Light blue for replies */
            border-left: 4px solid #60a5fa;
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
        .admin-reply-badge {
            background-color: #fcd34d; /* Yellow for admin replies */
            color: #92400e;
            padding: 0.2rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }
        .reply-form-container {
            margin-top: 1rem;
            padding: 1rem;
            background-color: #f3f4f6;
            border-radius: 0.75rem;
            border: 1px solid #e5e7eb;
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col min-h-screen">
    <div class="container">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">留言板</h1>

        <!-- 留言提交表单 -->
        <div class="mb-8 p-6 bg-white rounded-xl shadow-md">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">发表留言</h2>
            <form id="messageForm" class="space-y-4">
                <div>
                    <label for="username" class="block text-sm font-medium text-gray-700 mb-1">用户名:</label>
                    <input type="text" id="username" class="input-field" placeholder="您的名字" required>
                </div>
                <div>
                    <label for="message" class="block text-sm font-medium text-gray-700 mb-1">留言:</label>
                    <textarea id="message" class="input-field" placeholder="写下您的留言..." required></textarea>
                </div>
                <button type="submit" class="btn btn-primary w-full">提交留言</button>
            </form>
            <p class="text-sm text-gray-600 text-center mt-4" id="currentPostingHours">当前发言时段：加载中...</p>
        </div>

        <!-- 留言列表 -->
        <div class="mb-8 p-6 bg-white rounded-xl shadow-md">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">所有留言</h2>
            <div id="messagesContainer">
                <!-- 留言将在这里动态加载 -->
                <p class="text-gray-500 text-center" id="noMessagesText">暂无留言。</p>
            </div>
        </div>

        <!-- 管理员登录 -->
        <div class="p-6 bg-white rounded-xl shadow-md">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">管理员登录</h2>
            <form id="adminLoginForm" class="space-y-4">
                <div>
                    <label for="adminPassword" class="block text-sm font-medium text-gray-700 mb-1">管理员密码:</label>
                    <input type="password" id="adminPassword" class="input-field" placeholder="输入管理员密码" required>
                </div>
                <button type="submit" class="btn btn-primary w-full">登录</button>
            </form>
            <p id="adminStatus" class="text-center mt-4 text-sm"></p>
            <button id="adminLogoutBtn" class="btn btn-danger w-full mt-4 hidden">退出管理员</button>
        </div>

        <!-- 管理员设置发言时段 -->
        <div class="p-6 bg-white rounded-xl shadow-md mt-6" id="adminConfigSection" style="display: none;">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">设置发言时段 (管理员)</h2>
            <div class="space-y-4">
                <div>
                    <label for="setStartTime" class="block text-sm font-medium text-gray-700 mb-1">开始时间:</label>
                    <input type="datetime-local" id="setStartTime" class="input-field" required>
                </div>
                <div>
                    <label for="setEndTime" class="block text-sm font-medium text-gray-700 mb-1">结束时间:</label>
                    <input type="datetime-local" id="setEndTime" class="input-field" required>
                </div>
                <button id="savePostingHoursBtn" class="btn btn-primary w-full">保存设置</button>
            </div>
            <p id="postingHoursStatus" class="text-center mt-4 text-sm"></p>
        </div>
    </div>

    <!-- Developer Info Footer -->
    <footer class="mt-8 py-4 text-center text-gray-600 text-sm">
        <div class="container mx-auto">
            <p>开发者信息：Mr_Onion</p>
            <p>联系邮箱：admin@mr-onion-blog.fun</p>
            <p>开发者首页：<a href="https://mr-onion-blog.fun" target="_blank" class="text-blue-600 hover:underline">Mr_Onion's Blog</a></p>
            <p class="mt-2">&copy; 2024 NSOI题目审核系统. All rights reserved.</p>
        </div>
    </footer>

    <script>
        // Configure your Cloudflare Worker URL
        const WORKER_URL = 'https://guest.mr-onion-blog.fun'; // <-- **PLEASE REPLACE WITH YOUR WORKER URL**

        let isAdmin = localStorage.getItem('isAdmin') === 'true'; // Check admin status from local storage
        let postingStartTime; // Will be YYYY-MM-DDTHH:MM
        let postingEndTime;   // Will be YYYY-MM-DDTHH:MM

        // Helper to get current date in YYYY-MM-DD format
        function getCurrentDateFormatted() {
            const now = new Date();
            const year = now.getFullYear();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const day = now.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Default full date-time strings for "all day"
        const defaultFullStartTime = `${getCurrentDateFormatted()}T00:00`;
        const defaultFullEndTime = `${getCurrentDateFormatted()}T23:59`;

        // Initialize with current date's start/end times
        postingStartTime = defaultFullStartTime;
        postingEndTime = defaultFullEndTime;


        const messagesContainer = document.getElementById('messagesContainer');
        const messageForm = document.getElementById('messageForm');
        const adminLoginForm = document.getElementById('adminLoginForm');
        const adminPasswordInput = document.getElementById('adminPassword');
        const adminStatusText = document.getElementById('adminStatus');
        const adminLogoutBtn = document.getElementById('adminLogoutBtn');
        const noMessagesText = document.getElementById('noMessagesText');
        const adminConfigSection = document.getElementById('adminConfigSection');
        const setStartTimeInput = document.getElementById('setStartTime');
        const setEndTimeInput = document.getElementById('setEndTime');
        const savePostingHoursBtn = document.getElementById('savePostingHoursBtn');
        const postingHoursStatusText = document.getElementById('postingHoursStatus');
        const currentPostingHoursText = document.getElementById('currentPostingHours');

        // Helper function: format timestamp
        function formatTimestamp(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        // Check if current time is within the allowed posting hours
        function isCurrentTimeWithinHours() {
            // Ensure postingStartTime and postingEndTime are valid date-time strings
            if (!postingStartTime || !postingEndTime) {
                console.warn("Posting times not set, assuming always allowed.");
                return true; // If times are not configured, assume always allowed
            }

            const now = new Date();
            const start = new Date(postingStartTime);
            const end = new Date(postingEndTime);

            // Check for invalid Date objects (e.g., if parsing failed)
            if (isNaN(start.getTime()) || isNaN(end.getTime())) {
                console.error("Invalid posting time configuration.");
                return true; // Fallback to always allowed if config is invalid
            }

            return now.getTime() >= start.getTime() && now.getTime() <= end.getTime();
        }

        // Update posting hours display
        function updatePostingHoursDisplay() {
            if (postingStartTime === defaultFullStartTime && postingEndTime === defaultFullEndTime) {
                currentPostingHoursText.textContent = '当前发言时段：全天开放';
            } else {
                // Format for display: YYYY年MM月DD日 HH:MM
                const startDisplay = new Date(postingStartTime).toLocaleString('zh-CN', {
                    year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'
                });
                const endDisplay = new Date(postingEndTime).toLocaleString('zh-CN', {
                    year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'
                });
                currentPostingHoursText.textContent = `当前发言时段：${startDisplay} ~ ${endDisplay}`;
            }
        }

        // Render message list
        function renderMessages(messages) {
            messagesContainer.innerHTML = ''; // Clear existing messages
            if (messages.length === 0) {
                noMessagesText.style.display = 'block';
            } else {
                noMessagesText.style.display = 'none';
                messages.forEach(msg => {
                    const messageCard = document.createElement('div');
                    messageCard.className = 'message-card';
                    messageCard.innerHTML = `
                        <div class="message-header">
                            <div class="message-content-main">
                                <p class="text-lg font-semibold text-gray-900">${msg.username ?? ''}</p>
                                <p class="text-gray-700 mt-1">${msg.message ?? ''}</p>
                                <p class="text-xs text-gray-500 mt-2">发表于: ${formatTimestamp(msg.timestamp ?? 0)}</p>
                            </div>
                            ${isAdmin ? `
                                <div class="admin-controls">
                                    <button class="btn btn-danger text-sm delete-btn" data-id="${msg.id}">删除</button>
                                </div>
                            ` : ''}
                        </div>
                        <div class="replies-container w-full">
                            <h4 class="text-md font-semibold text-gray-700 mb-2">回复:</h4>
                            <div class="replies-list-${msg.id}">
                                ${msg.replies && msg.replies.length > 0 ?
                                    msg.replies.map(reply => `
                                        <div class="reply-card">
                                            <p class="font-medium text-gray-800">
                                                ${reply.username ?? ''}
                                                ${reply.isAdminReply ? '<span class="admin-reply-badge">管理员回复</span>' : ''}
                                            </p>
                                            <p class="text-gray-700">${reply.message ?? ''}</p>
                                            <p class="text-xs text-gray-500 mt-1">${formatTimestamp(reply.timestamp ?? 0)}</p>
                                        </div>
                                    `).join('')
                                    : '<p class="text-gray-500 text-sm">暂无回复。</p>'
                                }
                            </div>
                            <button class="btn btn-secondary text-sm mt-3 toggle-reply-form" data-id="${msg.id}">回复</button>
                            <div class="reply-form-container hidden mt-3" id="replyFormContainer-${msg.id}">
                                <h5 class="text-md font-semibold text-gray-700 mb-2">添加回复:</h5>
                                <form class="reply-form" data-id="${msg.id}">
                                    <div>
                                        <label for="replyUsername-${msg.id}" class="block text-sm font-medium text-gray-700 mb-1">用户名:</label>
                                        <input type="text" id="replyUsername-${msg.id}" class="input-field" placeholder="您的名字" value="${isAdmin ? '管理员' : ''}" required>
                                    </div>
                                    <div>
                                        <label for="replyMessage-${msg.id}" class="block text-sm font-medium text-gray-700 mb-1">回复内容:</label>
                                        <textarea id="replyMessage-${msg.id}" class="input-field" placeholder="写下您的回复..." required></textarea>
                                    </div>
                                    <button type="submit" class="btn btn-primary w-full">提交回复</button>
                                </form>
                            </div>
                        </div>
                    `;
                    messagesContainer.appendChild(messageCard);
                });

                // Add event listeners for delete buttons (if admin is logged in)
                if (isAdmin) {
                    document.querySelectorAll('.delete-btn').forEach(button => {
                        button.addEventListener('click', async (e) => {
                            const messageId = e.target.dataset.id;
                            // Use custom modal instead of alert() and confirm()
                            showCustomConfirm('确定要删除这条留言吗？', async () => {
                                await deleteMessage(messageId);
                            });
                        });
                    });
                }

                // Add event listeners for reply buttons
                document.querySelectorAll('.toggle-reply-form').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const messageId = e.target.dataset.id;
                        const replyFormContainer = document.getElementById(`replyFormContainer-${messageId}`);
                        replyFormContainer.classList.toggle('hidden');
                        // If admin, auto-fill username
                        if (isAdmin) {
                            document.getElementById(`replyUsername-${messageId}`).value = '管理员';
                        }
                    });
                });

                // Add event listeners for reply forms
                document.querySelectorAll('.reply-form').forEach(form => {
                    form.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const messageId = e.target.dataset.id;
                        const replyUsername = document.getElementById(`replyUsername-${messageId}`).value;
                        const replyMessage = document.getElementById(`replyMessage-${messageId}`).value;

                        await addReply(messageId, replyUsername, replyMessage, isAdmin);

                        // Hide form and clear content
                        document.getElementById(`replyFormContainer-${messageId}`).classList.add('hidden');
                        document.getElementById(`replyUsername-${messageId}`).value = isAdmin ? '管理员' : '';
                        document.getElementById(`replyMessage-${messageId}`).value = '';
                    });
                });
            }
        }

        // Fetch messages
        async function fetchMessages() {
            try {
                const response = await fetch(`${WORKER_URL}/messages`);
                if (!response.ok) {
                    throw new Error(`HTTP Error! Status: ${response.status}`);
                }
                const rawMessages = await response.json();
                
                // Filter out any malformed messages before rendering
                const messages = rawMessages.filter(msg => 
                    typeof msg === 'object' && msg !== null &&
                    typeof msg.id === 'string' &&
                    typeof msg.username === 'string' &&
                    typeof msg.message === 'string' &&
                    typeof msg.timestamp === 'number'
                );

                // Sort by timestamp in descending order (latest first)
                messages.sort((a, b) => b.timestamp - a.timestamp);
                renderMessages(messages);
            } catch (error) {
                console.error('Failed to fetch messages:', error);
                messagesContainer.innerHTML = `<p class="text-red-500 text-center">Failed to load messages.</p>`;
            }
        }

        // Fetch configuration (posting hours)
        async function fetchConfig() {
            try {
                const response = await fetch(`${WORKER_URL}/config`);
                if (!response.ok) {
                    throw new Error(`HTTP Error! Status: ${response.status}`);
                }
                const config = await response.json();
                postingStartTime = config.postingStartTime || defaultFullStartTime;
                postingEndTime = config.postingEndTime || defaultFullEndTime;
                updatePostingHoursDisplay();
                if (isAdmin) {
                    setStartTimeInput.value = postingStartTime;
                    setEndTimeInput.value = postingEndTime;
                }
            } catch (error) {
                console.error('Failed to fetch config:', error);
                postingHoursStatusText.textContent = 'Failed to fetch posting hours.';
                postingHoursStatusText.className = 'text-center mt-4 text-sm text-red-600';
                updatePostingHoursDisplay(); // Keep default display
            }
        }

        // Submit message
        messageForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const message = document.getElementById('message').value;

            // For non-admin users, check posting hours
            if (!isAdmin) {
                if (!isCurrentTimeWithinHours()) {
                    const startDisplay = new Date(postingStartTime).toLocaleString('zh-CN', {
                        year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'
                    });
                    const endDisplay = new Date(postingEndTime).toLocaleString('zh-CN', {
                        year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'
                    });
                    showCustomAlert(`当前不在允许的发言时段内。发言时段：${startDisplay} ~ ${endDisplay}`);
                    return; // Prevent form submission
                }
            }

            try {
                const headers = { 'Content-Type': 'application/json' };
                if (isAdmin) {
                    headers['X-Admin-Token'] = 'true'; // If admin, send admin token
                }

                const response = await fetch(`${WORKER_URL}/messages`, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({ username, message }),
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP Error! Status: ${response.status}, Message: ${errorText}`);
                }

                document.getElementById('username').value = '';
                document.getElementById('message').value = '';
                await fetchMessages(); // Refresh message list
            } catch (error) {
                console.error('Failed to submit message:', error);
                showCustomAlert('Failed to submit message. ' + (error.message || '')); // Use custom modal
            }
        });

        // Admin login
        adminLoginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const password = adminPasswordInput.value;

            try {
                const response = await fetch(`${WORKER_URL}/admin/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ password }),
                });

                if (!response.ok) {
                    throw new Error(`HTTP Error! Status: ${response.status}`);
                }

                const result = await response.json();
                if (result.success) {
                    isAdmin = true;
                    localStorage.setItem('isAdmin', 'true');
                    adminStatusText.textContent = '登录成功！';
                    adminStatusText.className = 'text-center mt-4 text-sm text-green-600';
                    adminLogoutBtn.classList.remove('hidden');
                    adminLoginForm.classList.add('hidden'); // Hide login form
                    adminConfigSection.style.display = 'block'; // Show admin config section
                    await fetchMessages(); // Refresh to show delete buttons
                    await fetchConfig(); // Refresh config display
                } else {
                    isAdmin = false;
                    localStorage.setItem('isAdmin', 'false');
                    adminStatusText.textContent = '密码错误。';
                    adminStatusText.className = 'text-center mt-4 text-sm text-red-600';
                }
            } catch (error) {
                console.error('Admin login failed:', error);
                adminStatusText.textContent = '登录请求失败。';
                adminStatusText.className = 'text-center mt-4 text-sm text-red-600';
            } finally {
                adminPasswordInput.value = '';
            }
        });

        // Admin logout
        adminLogoutBtn.addEventListener('click', () => {
            isAdmin = false;
            localStorage.setItem('isAdmin', 'false');
            adminStatusText.textContent = '已退出。';
            adminStatusText.className = 'text-center mt-4 text-sm text-gray-600';
            adminLogoutBtn.classList.add('hidden');
            adminLoginForm.classList.remove('hidden'); // Show login form
            adminConfigSection.style.display = 'none'; // Hide admin config section
            fetchMessages(); // Refresh to hide delete buttons
            fetchConfig(); // Refresh config display
        });

        // Delete message
        async function deleteMessage(id) {
            try {
                const response = await fetch(`${WORKER_URL}/messages/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Admin-Token': 'true', // Simple token, Worker will check this
                    },
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP Error! Status: ${response.status}, Message: ${errorText}`);
                }

                await fetchMessages(); // Refresh message list
            } catch (error) {
                console.error('Failed to delete message:', error);
                showCustomAlert('Failed to delete message. ' + (error.message || '')); // Use custom modal
            }
        }

        // Add reply
        async function addReply(messageId, username, replyMessage, isAdminReply) {
            try {
                const headers = { 'Content-Type': 'application/json' };
                if (isAdminReply) {
                    headers['X-Admin-Token'] = 'true'; // If admin reply, send admin token
                }

                const response = await fetch(`${WORKER_URL}/messages/${messageId}/replies`, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({ username, message: replyMessage, isAdminReply }),
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP Error! Status: ${response.status}, Message: ${errorText}`);
                }

                await fetchMessages(); // Refresh message list to show new reply
            } catch (error) {
                console.error('Failed to add reply:', error);
                showCustomAlert('Failed to add reply. ' + (error.message || '')); // Use custom modal
            }
        }

        // Save posting hours settings
        savePostingHoursBtn.addEventListener('click', async () => {
            const startTime = setStartTimeInput.value;
            const endTime = setEndTimeInput.value;

            if (!startTime || !endTime) {
                postingHoursStatusText.textContent = '请填写开始时间和结束时间。';
                postingHoursStatusText.className = 'text-center mt-4 text-sm text-red-600';
                return;
            }

            try {
                const response = await fetch(`${WORKER_URL}/config`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Admin-Token': 'true', // Must send admin token
                    },
                    body: JSON.stringify({ postingStartTime: startTime, postingEndTime: endTime }),
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP Error! Status: ${response.status}, Message: ${errorText}`);
                }

                const result = await response.json();
                if (result.success) {
                    postingHoursStatusText.textContent = '发言时段设置成功！';
                    postingHoursStatusText.className = 'text-center mt-4 text-sm text-green-600';
                    await fetchConfig(); // Refresh posting hours display on page
                } else {
                    postingHoursStatusText.textContent = '设置失败。';
                    postingHoursStatusText.className = 'text-center mt-4 text-sm text-red-600';
                }
            } catch (error) {
                console.error('Failed to save posting hours:', error);
                postingHoursStatusText.textContent = 'Failed to save posting hours. ' + (error.message || '');
                postingHoursStatusText.className = 'text-center mt-4 text-sm text-red-600';
            }
        });


        // Custom modal functions (replacing alert and confirm)
        function showCustomAlert(message) {
            const modalHtml = `
                <div id="customAlertModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
                        <p class="text-lg text-gray-800 mb-4">${message}</p>
                        <button id="customAlertCloseBtn" class="btn btn-primary w-full">确定</button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            document.getElementById('customAlertCloseBtn').addEventListener('click', () => {
                document.getElementById('customAlertModal').remove();
            });
        }

        function showCustomConfirm(message, onConfirm) {
            const modalHtml = `
                <div id="customConfirmModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
                        <p class="text-lg text-gray-800 mb-4">${message}</p>
                        <div class="flex justify-end space-x-3">
                            <button id="customConfirmCancelBtn" class="btn btn-secondary">取消</button>
                            <button id="customConfirmOkBtn" class="btn btn-danger">确定</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            document.getElementById('customConfirmOkBtn').addEventListener('click', () => {
                onConfirm();
                document.getElementById('customConfirmModal').remove();
            });
            document.getElementById('customConfirmCancelBtn').addEventListener('click', () => {
                document.getElementById('customConfirmModal').remove();
            });
        }


        // Initialize: fetch messages and update admin status display
        document.addEventListener('DOMContentLoaded', () => {
            fetchMessages();
            fetchConfig(); // Fetch config on page load
            if (isAdmin) {
                adminStatusText.textContent = '已登录为管理员。';
                adminStatusText.className = 'text-center mt-4 text-sm text-green-600';
                adminLogoutBtn.classList.remove('hidden');
                adminLoginForm.classList.add('hidden');
                adminConfigSection.style.display = 'block'; // Show admin config section
            } else {
                adminStatusText.textContent = '未登录管理员。';
                adminStatusText.className = 'text-center mt-4 text-sm text-gray-600';
                adminLogoutBtn.classList.add('hidden');
                adminLoginForm.classList.remove('hidden');
                adminConfigSection.style.display = 'none'; // Hide admin config section
            }
        });
    </script>
</body>
</html>
