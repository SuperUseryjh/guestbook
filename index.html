<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>留言板</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        .container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 1.5rem;
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .message-card {
            background-color: #f9fafb;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column; /* Changed to column to stack content and replies */
            justify-content: space-between;
            align-items: flex-start;
        }
        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            width: 100%;
            margin-bottom: 0.5rem;
        }
        .message-content-main {
            flex-grow: 1;
            width: 100%;
        }
        .admin-controls {
            flex-shrink: 0;
            margin-left: 1rem;
        }
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s ease-in-out;
        }
        .btn-primary {
            background-color: #4f46e5;
            color: white;
        }
        .btn-primary:hover {
            background-color: #4338ca;
        }
        .btn-danger {
            background-color: #ef4444;
            color: white;
        }
        .btn-danger:hover {
            background-color: #dc2626;
        }
        .btn-secondary {
            background-color: #6b7280;
            color: white;
        }
        .btn-secondary:hover {
            background-color: #4b5563;
        }
        .input-field {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            box-sizing: border-box;
        }
        textarea.input-field {
            min-height: 100px;
            resize: vertical;
        }
        .replies-container {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb;
            width: 100%;
        }
        .reply-card {
            background-color: #eff6ff; /* Light blue for replies */
            border-left: 4px solid #60a5fa;
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
        .admin-reply-badge {
            background-color: #fcd34d; /* Yellow for admin replies */
            color: #92400e;
            padding: 0.2rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }
        .reply-form-container {
            margin-top: 1rem;
            padding: 1rem;
            background-color: #f3f4f6;
            border-radius: 0.75rem;
            border: 1px solid #e5e7eb;
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col min-h-screen">
    <div class="container">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">留言板</h1>

        <!-- 留言提交表单 -->
        <div class="mb-8 p-6 bg-white rounded-xl shadow-md">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">发表留言</h2>
            <form id="messageForm" class="space-y-4">
                <div>
                    <label for="username" class="block text-sm font-medium text-gray-700 mb-1">用户名:</label>
                    <input type="text" id="username" class="input-field" placeholder="您的名字" required>
                </div>
                <div>
                    <label for="message" class="block text-sm font-medium text-gray-700 mb-1">留言:</label>
                    <textarea id="message" class="input-field" placeholder="写下您的留言..." required></textarea>
                </div>
                <button type="submit" class="btn btn-primary w-full">提交留言</button>
            </form>
            <p class="text-sm text-gray-600 text-center mt-4" id="currentPostingHours">当前发言时段：加载中...</p>
        </div>

        <!-- 留言列表 -->
        <div class="mb-8 p-6 bg-white rounded-xl shadow-md">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">所有留言</h2>
            <div id="messagesContainer">
                <!-- 留言将在这里动态加载 -->
                <p class="text-gray-500 text-center" id="noMessagesText">暂无留言。</p>
            </div>
        </div>

        <!-- 管理员登录 -->
        <div class="p-6 bg-white rounded-xl shadow-md">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">管理员登录</h2>
            <form id="adminLoginForm" class="space-y-4">
                <div>
                    <label for="adminPassword" class="block text-sm font-medium text-gray-700 mb-1">管理员密码:</label>
                    <input type="password" id="adminPassword" class="input-field" placeholder="输入管理员密码" required>
                </div>
                <button type="submit" class="btn btn-primary w-full">登录</button>
            </form>
            <p id="adminStatus" class="text-center mt-4 text-sm"></p>
            <button id="adminLogoutBtn" class="btn btn-danger w-full mt-4 hidden">退出管理员</button>
        </div>

        <!-- 管理员设置发言时段 -->
        <div class="p-6 bg-white rounded-xl shadow-md mt-6" id="adminConfigSection" style="display: none;">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">设置发言时段 (管理员)</h2>
            <div class="space-y-4">
                <div>
                    <label for="setStartTime" class="block text-sm font-medium text-gray-700 mb-1">开始时间:</label>
                    <input type="time" id="setStartTime" class="input-field" required>
                </div>
                <div>
                    <label for="setEndTime" class="block text-sm font-medium text-gray-700 mb-1">结束时间:</label>
                    <input type="time" id="setEndTime" class="input-field" required>
                </div>
                <button id="savePostingHoursBtn" class="btn btn-primary w-full">保存设置</button>
            </div>
            <p id="postingHoursStatus" class="text-center mt-4 text-sm"></p>
        </div>
    </div>

    <script>
        // 配置您的 Cloudflare Worker URL
        const WORKER_URL = 'YOUR_CLOUDFLARE_WORKER_URL'; // <-- **请替换为您的 Worker URL**

        let isAdmin = localStorage.getItem('isAdmin') === 'true'; // 从本地存储检查管理员状态
        let postingStartTime = '00:00'; // 默认全天
        let postingEndTime = '23:59'; // 默认全天

        const messagesContainer = document.getElementById('messagesContainer');
        const messageForm = document.getElementById('messageForm');
        const adminLoginForm = document.getElementById('adminLoginForm');
        const adminPasswordInput = document.getElementById('adminPassword');
        const adminStatusText = document.getElementById('adminStatus');
        const adminLogoutBtn = document.getElementById('adminLogoutBtn');
        const noMessagesText = document.getElementById('noMessagesText');
        const adminConfigSection = document.getElementById('adminConfigSection');
        const setStartTimeInput = document.getElementById('setStartTime');
        const setEndTimeInput = document.getElementById('setEndTime');
        const savePostingHoursBtn = document.getElementById('savePostingHoursBtn');
        const postingHoursStatusText = document.getElementById('postingHoursStatus');
        const currentPostingHoursText = document.getElementById('currentPostingHours');

        // 辅助函数：格式化时间戳
        function formatTimestamp(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        // 检查当前时间是否在允许的发言时段内
        function isCurrentTimeWithinHours() {
            const now = new Date();
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();
            const currentTimeInMinutes = currentHour * 60 + currentMinute;

            const [startHour, startMinute] = postingStartTime.split(':').map(Number);
            const startTimeInMinutes = startHour * 60 + startMinute;

            const [endHour, endMinute] = postingEndTime.split(':').map(Number);
            const endTimeInMinutes = endHour * 60 + endMinute;

            let isAllowed = false;
            if (startTimeInMinutes <= endTimeInMinutes) {
                // 正常情况：开始时间在结束时间之前或相同 (例如 09:00 - 17:00)
                isAllowed = currentTimeInMinutes >= startTimeInMinutes && currentTimeInMinutes <= endTimeInMinutes;
            } else {
                // 跨夜情况：结束时间在第二天 (例如 22:00 - 06:00)
                isAllowed = currentTimeInMinutes >= startTimeInMinutes || currentTimeInMinutes <= endTimeInMinutes;
            }
            return isAllowed;
        }

        // 更新发言时段显示
        function updatePostingHoursDisplay() {
            if (postingStartTime === '00:00' && postingEndTime === '23:59') {
                currentPostingHoursText.textContent = '当前发言时段：全天开放';
            } else {
                currentPostingHoursText.textContent = `当前发言时段：${postingStartTime} - ${postingEndTime}`;
            }
        }

        // 渲染留言列表
        function renderMessages(messages) {
            messagesContainer.innerHTML = ''; // 清空现有留言
            if (messages.length === 0) {
                noMessagesText.style.display = 'block';
            } else {
                noMessagesText.style.display = 'none';
                messages.forEach(msg => {
                    const messageCard = document.createElement('div');
                    messageCard.className = 'message-card';
                    messageCard.innerHTML = `
                        <div class="message-header">
                            <div class="message-content-main">
                                <p class="text-lg font-semibold text-gray-900">${msg.username}</p>
                                <p class="text-gray-700 mt-1">${msg.message}</p>
                                <p class="text-xs text-gray-500 mt-2">发表于: ${formatTimestamp(msg.timestamp)}</p>
                            </div>
                            ${isAdmin ? `
                                <div class="admin-controls">
                                    <button class="btn btn-danger text-sm delete-btn" data-id="${msg.id}">删除</button>
                                </div>
                            ` : ''}
                        </div>
                        <div class="replies-container w-full">
                            <h4 class="text-md font-semibold text-gray-700 mb-2">回复:</h4>
                            <div class="replies-list-${msg.id}">
                                ${msg.replies && msg.replies.length > 0 ?
                                    msg.replies.map(reply => `
                                        <div class="reply-card">
                                            <p class="font-medium text-gray-800">
                                                ${reply.username}
                                                ${reply.isAdminReply ? '<span class="admin-reply-badge">管理员回复</span>' : ''}
                                            </p>
                                            <p class="text-gray-700">${reply.message}</p>
                                            <p class="text-xs text-gray-500 mt-1">${formatTimestamp(reply.timestamp)}</p>
                                        </div>
                                    `).join('')
                                    : '<p class="text-gray-500 text-sm">暂无回复。</p>'
                                }
                            </div>
                            <button class="btn btn-secondary text-sm mt-3 toggle-reply-form" data-id="${msg.id}">回复</button>
                            <div class="reply-form-container hidden mt-3" id="replyFormContainer-${msg.id}">
                                <h5 class="text-md font-semibold text-gray-700 mb-2">添加回复:</h5>
                                <form class="reply-form" data-id="${msg.id}">
                                    <div>
                                        <label for="replyUsername-${msg.id}" class="block text-sm font-medium text-gray-700 mb-1">用户名:</label>
                                        <input type="text" id="replyUsername-${msg.id}" class="input-field" placeholder="您的名字" value="${isAdmin ? '管理员' : ''}" required>
                                    </div>
                                    <div>
                                        <label for="replyMessage-${msg.id}" class="block text-sm font-medium text-gray-700 mb-1">回复内容:</label>
                                        <textarea id="replyMessage-${msg.id}" class="input-field" placeholder="写下您的回复..." required></textarea>
                                    </div>
                                    <button type="submit" class="btn btn-primary w-full">提交回复</button>
                                </form>
                            </div>
                        </div>
                    `;
                    messagesContainer.appendChild(messageCard);
                });

                // 为删除按钮添加事件监听器 (如果管理员已登录)
                if (isAdmin) {
                    document.querySelectorAll('.delete-btn').forEach(button => {
                        button.addEventListener('click', async (e) => {
                            const messageId = e.target.dataset.id;
                            // 使用自定义模态框替代 alert() 和 confirm()
                            showCustomConfirm('确定要删除这条留言吗？', async () => {
                                await deleteMessage(messageId);
                            });
                        });
                    });
                }

                // 为回复按钮添加事件监听器
                document.querySelectorAll('.toggle-reply-form').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const messageId = e.target.dataset.id;
                        const replyFormContainer = document.getElementById(`replyFormContainer-${messageId}`);
                        replyFormContainer.classList.toggle('hidden');
                        // 如果是管理员，自动填充用户名
                        if (isAdmin) {
                            document.getElementById(`replyUsername-${messageId}`).value = '管理员';
                        }
                    });
                });

                // 为回复表单添加事件监听器
                document.querySelectorAll('.reply-form').forEach(form => {
                    form.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const messageId = e.target.dataset.id;
                        const replyUsername = document.getElementById(`replyUsername-${messageId}`).value;
                        const replyMessage = document.getElementById(`replyMessage-${messageId}`).value;

                        await addReply(messageId, replyUsername, replyMessage, isAdmin);

                        // 隐藏表单并清空内容
                        document.getElementById(`replyFormContainer-${messageId}`).classList.add('hidden');
                        document.getElementById(`replyUsername-${messageId}`).value = isAdmin ? '管理员' : '';
                        document.getElementById(`replyMessage-${messageId}`).value = '';
                    });
                });
            }
        }

        // 获取留言
        async function fetchMessages() {
            try {
                const response = await fetch(`${WORKER_URL}/messages`);
                if (!response.ok) {
                    throw new Error(`HTTP 错误！状态: ${response.status}`);
                }
                const messages = await response.json();
                // 按时间戳降序排序，最新的在最上面
                messages.sort((a, b) => b.timestamp - a.timestamp);
                renderMessages(messages);
            } catch (error) {
                console.error('获取留言失败:', error);
                messagesContainer.innerHTML = `<p class="text-red-500 text-center">加载留言失败。</p>`;
            }
        }

        // 获取配置 (发言时段)
        async function fetchConfig() {
            try {
                const response = await fetch(`${WORKER_URL}/config`);
                if (!response.ok) {
                    throw new Error(`HTTP 错误！状态: ${response.status}`);
                }
                const config = await response.json();
                postingStartTime = config.postingStartTime || '00:00';
                postingEndTime = config.postingEndTime || '23:59';
                updatePostingHoursDisplay();
                if (isAdmin) {
                    setStartTimeInput.value = postingStartTime;
                    setEndTimeInput.value = postingEndTime;
                }
            } catch (error) {
                console.error('获取配置失败:', error);
                postingHoursStatusText.textContent = '获取发言时段失败。';
                postingHoursStatusText.className = 'text-center mt-4 text-sm text-red-600';
                updatePostingHoursDisplay(); // 保持默认值显示
            }
        }

        // 提交留言
        messageForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const message = document.getElementById('message').value;

            // 非管理员用户检查发言时段
            if (!isAdmin) {
                if (!isCurrentTimeWithinHours()) {
                    showCustomAlert(`当前不在允许的发言时段内。发言时段：${postingStartTime} - ${postingEndTime}`);
                    return; // 阻止表单提交
                }
            }

            try {
                const headers = { 'Content-Type': 'application/json' };
                if (isAdmin) {
                    headers['X-Admin-Token'] = 'true'; // 如果是管理员，发送管理员令牌
                }

                const response = await fetch(`${WORKER_URL}/messages`, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({ username, message }),
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP 错误！状态: ${response.status}, 消息: ${errorText}`);
                }

                document.getElementById('username').value = '';
                document.getElementById('message').value = '';
                await fetchMessages(); // 刷新留言列表
            } catch (error) {
                console.error('提交留言失败:', error);
                showCustomAlert('提交留言失败。' + (error.message || '')); // 使用自定义模态框
            }
        });

        // 管理员登录
        adminLoginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const password = adminPasswordInput.value;

            try {
                const response = await fetch(`${WORKER_URL}/admin/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ password }),
                });

                if (!response.ok) {
                    throw new Error(`HTTP 错误！状态: ${response.status}`);
                }

                const result = await response.json();
                if (result.success) {
                    isAdmin = true;
                    localStorage.setItem('isAdmin', 'true');
                    adminStatusText.textContent = '登录成功！';
                    adminStatusText.className = 'text-center mt-4 text-sm text-green-600';
                    adminLogoutBtn.classList.remove('hidden');
                    adminLoginForm.classList.add('hidden'); // 隐藏登录表单
                    adminConfigSection.style.display = 'block'; // 显示管理员配置区
                    await fetchMessages(); // 刷新以显示删除按钮
                    await fetchConfig(); // 刷新配置显示
                } else {
                    isAdmin = false;
                    localStorage.setItem('isAdmin', 'false');
                    adminStatusText.textContent = '密码错误。';
                    adminStatusText.className = 'text-center mt-4 text-sm text-red-600';
                }
            } catch (error) {
                console.error('管理员登录失败:', error);
                adminStatusText.textContent = '登录请求失败。';
                adminStatusText.className = 'text-center mt-4 text-sm text-red-600';
            } finally {
                adminPasswordInput.value = '';
            }
        });

        // 管理员退出
        adminLogoutBtn.addEventListener('click', () => {
            isAdmin = false;
            localStorage.setItem('isAdmin', 'false');
            adminStatusText.textContent = '已退出。';
            adminStatusText.className = 'text-center mt-4 text-sm text-gray-600';
            adminLogoutBtn.classList.add('hidden');
            adminLoginForm.classList.remove('hidden'); // 显示登录表单
            adminConfigSection.style.display = 'none'; // 隐藏管理员配置区
            fetchMessages(); // 刷新以隐藏删除按钮
            fetchConfig(); // 刷新配置显示
        });

        // 删除留言
        async function deleteMessage(id) {
            try {
                const response = await fetch(`${WORKER_URL}/messages/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Admin-Token': 'true', // 简单标记，Worker会检查这个
                    },
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP 错误！状态: ${response.status}, 消息: ${errorText}`);
                }

                await fetchMessages(); // 刷新留言列表
            } catch (error) {
                console.error('删除留言失败:', error);
                showCustomAlert('删除留言失败。' + (error.message || '')); // 使用自定义模态框
            }
        }

        // 添加回复
        async function addReply(messageId, username, replyMessage, isAdminReply) {
            try {
                const headers = { 'Content-Type': 'application/json' };
                if (isAdminReply) {
                    headers['X-Admin-Token'] = 'true'; // 如果是管理员回复，发送管理员令牌
                }

                const response = await fetch(`${WORKER_URL}/messages/${messageId}/replies`, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({ username, message: replyMessage, isAdminReply }),
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP 错误！状态: ${response.status}, 消息: ${errorText}`);
                }

                await fetchMessages(); // 刷新留言列表以显示新回复
            } catch (error) {
                console.error('添加回复失败:', error);
                showCustomAlert('添加回复失败。' + (error.message || '')); // 使用自定义模态框
            }
        }

        // 保存发言时段设置
        savePostingHoursBtn.addEventListener('click', async () => {
            const startTime = setStartTimeInput.value;
            const endTime = setEndTimeInput.value;

            if (!startTime || !endTime) {
                postingHoursStatusText.textContent = '请填写开始时间和结束时间。';
                postingHoursStatusText.className = 'text-center mt-4 text-sm text-red-600';
                return;
            }

            try {
                const response = await fetch(`${WORKER_URL}/config`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Admin-Token': 'true', // 必须发送管理员令牌
                    },
                    body: JSON.stringify({ postingStartTime: startTime, postingEndTime: endTime }),
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP 错误！状态: ${response.status}, 消息: ${errorText}`);
                }

                const result = await response.json();
                if (result.success) {
                    postingHoursStatusText.textContent = '发言时段设置成功！';
                    postingHoursStatusText.className = 'text-center mt-4 text-sm text-green-600';
                    await fetchConfig(); // 刷新页面上的时段显示
                } else {
                    postingHoursStatusText.textContent = '设置失败。';
                    postingHoursStatusText.className = 'text-center mt-4 text-sm text-red-600';
                }
            } catch (error) {
                console.error('保存发言时段失败:', error);
                postingHoursStatusText.textContent = '保存发言时段失败。' + (error.message || '');
                postingHoursStatusText.className = 'text-center mt-4 text-sm text-red-600';
            }
        });


        // 自定义模态框函数 (替代 alert 和 confirm)
        function showCustomAlert(message) {
            const modalHtml = `
                <div id="customAlertModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
                        <p class="text-lg text-gray-800 mb-4">${message}</p>
                        <button id="customAlertCloseBtn" class="btn btn-primary w-full">确定</button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            document.getElementById('customAlertCloseBtn').addEventListener('click', () => {
                document.getElementById('customAlertModal').remove();
            });
        }

        function showCustomConfirm(message, onConfirm) {
            const modalHtml = `
                <div id="customConfirmModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
                        <p class="text-lg text-gray-800 mb-4">${message}</p>
                        <div class="flex justify-end space-x-3">
                            <button id="customConfirmCancelBtn" class="btn btn-secondary">取消</button>
                            <button id="customConfirmOkBtn" class="btn btn-danger">确定</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            document.getElementById('customConfirmOkBtn').addEventListener('click', () => {
                onConfirm();
                document.getElementById('customConfirmModal').remove();
            });
            document.getElementById('customConfirmCancelBtn').addEventListener('click', () => {
                document.getElementById('customConfirmModal').remove();
            });
        }


        // 初始化加载留言和更新管理员状态显示
        document.addEventListener('DOMContentLoaded', () => {
            fetchMessages();
            fetchConfig(); // 页面加载时获取配置
            if (isAdmin) {
                adminStatusText.textContent = '已登录为管理员。';
                adminStatusText.className = 'text-center mt-4 text-sm text-green-600';
                adminLogoutBtn.classList.remove('hidden');
                adminLoginForm.classList.add('hidden');
                adminConfigSection.style.display = 'block'; // 显示管理员配置区
            } else {
                adminStatusText.textContent = '未登录管理员。';
                adminStatusText.className = 'text-center mt-4 text-sm text-gray-600';
                adminLogoutBtn.classList.add('hidden');
                adminLoginForm.classList.remove('hidden');
                adminConfigSection.style.display = 'none'; // 隐藏管理员配置区
            }
        });
    </script>
</body>
</html>
