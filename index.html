<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>留言板 | NSOI</title>
    <link rel="icon" href="https://mr-onion-blog.fun/img/avatar.png" type="image/png">
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* 与页脚背景色保持一致 */
            padding-top: 4rem; /* Add padding to body to prevent content from being hidden by fixed navbar */
        }
        .container {
            max-width: 800px;
            margin: 2rem auto; /* 保持居中：上下外边距2rem，左右外边距自动分配以实现水平居中 */
            padding: 1.5rem;
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .message-card {
            background-color: #f9fafb;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: flex-start;
            position: relative; /* For pinned badge positioning */
        }
        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            width: 100%;
            margin-bottom: 0.5rem;
        }
        .message-content-main {
            flex-grow: 1;
            width: 100%;
        }
        .admin-controls {
            flex-shrink: 0;
            margin-left: 1rem;
            display: flex; /* To align buttons horizontally */
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
            gap: 0.5rem; /* Spacing between buttons */
            align-items: center; /* Vertically align items */
        }
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s ease-in-out;
        }
        .btn-primary {
            background-color: #4f46e5;
            color: white;
        }
        .btn-primary:hover {
            background-color: #4338ca;
        }
        .btn-danger {
            background-color: #ef4444;
            color: white;
        }
        .btn-danger:hover {
            background-color: #dc2626;
        }
        .btn-secondary {
            background-color: #6b7280;
            color: white;
        }
        .btn-secondary:hover {
            background-color: #4b5563;
        }
        .btn-info { /* New style for Pin button */
            background-color: #3b82f6;
            color: white;
        }
        .btn-info:hover {
            background-color: #2563eb;
        }
        .input-field {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            box-sizing: border-box;
        }
        textarea.input-field {
            min-height: 100px;
            resize: vertical;
        }
        .replies-container {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb;
            width: 100%;
        }
        .reply-card {
            background-color: #eff6ff; /* Light blue for replies */
            border-left: 4px solid #60a5fa;
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
        .admin-reply-badge {
            background-color: #fcd34d; /* Yellow for admin replies */
            color: #92400e;
            padding: 0.2rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }
        /* New style for admin message badge */
        .admin-message-badge {
            background-color: #34d399; /* Green for admin messages */
            color: #065f46;
            padding: 0.2rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }
        /* New style for pinned message badge */
        .pinned-badge {
            background-color: #a78bfa; /* Purple for pinned messages */
            color: #4c1d95;
            padding: 0.2rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }
        .reply-form-container {
            margin-top: 1rem;
            padding: 1rem;
            background-color: #f3f4f6;
            border-radius: 0.75rem;
            border: 1px solid #e5e7eb;
        }
        .banned-ip-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px dashed #e5e7eb;
        }
        .banned-ip-item:last-child {
            border-bottom: none;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            max-width: 500px;
            width: 90%;
            text-align: center;
        }
        .modal-content h2 {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: #333;
        }
        .modal-content p {
            font-size: 1rem;
            line-height: 1.6;
            color: #555;
            text-align: left;
            margin-bottom: 1.5rem;
            max-height: 200px; /* Limit height for scroll */
            overflow-y: auto; /* Enable scroll if content overflows */
            border: 1px solid #e2e8f0;
            padding: 1rem;
            border-radius: 0.5rem;
            background-color: #f8fafc;
        }
        .modal-content button {
            margin-top: 1rem;
        }

        /* Settings Modal specific styles */
        .settings-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5); /* Semi-transparent background */
            backdrop-filter: blur(8px); /* Blurred background effect */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .settings-modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 90%;
            text-align: center;
            position: relative; /* For close button positioning */
        }
        .settings-modal-close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
        }
        .settings-modal-close-btn:hover {
            color: #374151;
        }

        /* Admin Panel Specific Styles */
        .admin-panel-nav-btn {
            display: block;
            width: 100%;
            padding: 0.75rem 1rem;
            text-align: left;
            background-color: #e2e8f0;
            color: #333;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
        }
        .admin-panel-nav-btn:hover {
            background-color: #cbd5e1;
        }
        .admin-panel-nav-btn.active {
            background-color: #4f46e5;
            color: white;
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col min-h-screen">
    <!-- Usage Terms Modal -->
    <div id="termsModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2>使用须知</h2>
            <p>
                欢迎使用留言板！为了维护良好的社区环境，请您在使用前仔细阅读以下须知：<br><br>
                1. 请勿发布任何违法、色情、暴力、歧视、人身攻击或侵犯他人权益的内容。<br>
                2. 请勿发布垃圾信息、广告或与本留言板主题无关的内容。<br>
                3. 请尊重他人，文明交流，友善发言。<br>
                4. 管理员有权删除不符合规定的留言，并对违规用户进行封禁处理。<br>
                5. 您的IP地址将在您发布留言时被记录，以用于防止恶意行为和垃圾信息。<br>
                6. 本留言板保留对本须知内容进行修改的权利，恕不另行通知。<br><br>
                感谢您的理解与配合！
            </p>
            <div class="flex items-center justify-center mt-4 mb-4">
                <input type="checkbox" id="hideTermsTodayCheckbox" class="mr-2">
                <label for="hideTermsTodayCheckbox" class="text-sm text-gray-700">今日不再显示</label>
            </div>
            <button id="agreeTermsBtn" class="btn btn-primary w-full">我已阅读并同意</button>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="settings-modal-overlay hidden">
        <div class="settings-modal-content">
            <button id="closeSettingsModalBtn" class="settings-modal-close-btn">&times;</button>
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">实用工具</h2>
            <div class="flex flex-col space-y-4">
                <button id="refreshMessagesBtn" class="btn btn-secondary w-full">刷新留言</button>
                <button id="deleteTermsCookieBtn" class="btn btn-secondary w-full">删除“今日不再显示”Cookie</button>
            </div>
        </div>
    </div>

    <!-- Navbar -->
    <nav class="bg-indigo-600 p-4 shadow-md flex justify-between items-center fixed top-0 w-full z-10">
        <div class="flex items-center">
            <img src="https://mr-onion-blog.fun/img/avatar.png" alt="NSOI Logo" class="h-8 w-8 rounded-full mr-2">
            <span class="text-white text-xl font-bold">NSOI 留言板</span>
        </div>
        <!-- Settings icon button with hardcoded SVG -->
        <button id="gearIcon" class="text-white hover:text-indigo-200 focus:outline-none">
            <svg t="1753181544601" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1480" xmlns:xlink="http://www.w3.org/1999/xlink" width="24" height="24">
                <path d="M346.112 59.904c27.52-11.776 64-4.096 84.48 17.472 23.04 24 60.416 48.896 84.352 48.896 23.68 0 61.056-24.576 83.712-47.872 18.624-19.456 50.752-27.328 77.248-19.52l7.808 2.816 2.176 1.088 119.424 66.56c25.088 17.536 35.84 50.112 27.136 78.72l-5.824 15.616a111.104 111.104 0 0 0-5.952 26.048 105.152 105.152 0 0 0 95.68 110.592l8.96 0.448h4.096c28.416 0 50.304 22.784 56.704 56.832l2.24 12.608 1.92 12.544c3.648 25.088 5.952 49.152 5.952 69.568 0 16.256-1.472 34.944-3.904 54.592l-2.048 14.976-2.816 17.6-1.28 7.424c-5.952 31.104-24.704 52.928-49.28 56.384l-6.784 0.448h-4.736c-57.92 0-105.024 47.104-105.024 105.024l0.192 5.184c0.64 6.784 2.176 14.208 4.416 21.76l3.2 9.6 1.344 3.392c12.416 27.84 4.736 61.248-17.92 81.536l-6.592 5.12-2.304 1.536-121.536 66.88c-8.96 3.84-18.56 5.824-28.544 5.824-21.504 0-42.56-8.96-56.448-24.192-22.912-25.28-61.44-52.032-86.08-52.032-23.36 0-62.272 25.792-85.568 50.944-18.56 20.224-50.752 28.544-77.44 20.672l-7.808-2.88-2.496-1.152-117.12-65.792a71.616 71.616 0 0 1-27.072-78.72l5.824-15.552 1.664-5.312c2.24-7.36 3.776-14.592 4.352-21.248l0.256-5.568c0-54.848-42.24-100.032-96-104.64l-8.96-0.384h-4.096c-28.416 0-50.304-22.784-56.704-56.464a111.104 111.104 0 0 1-10.112-94.72c0-31.296 5.44-71.424 10.112-94.656 5.888-31.104 24.64-52.928 49.152-56.32l6.784-0.512h4.8c57.92 0 105.024-47.104 105.024-105.024l-0.192-5.184a108.352 108.352 0 0 0-4.416-21.76l-3.2-9.6-1.408-3.328a71.552 71.552 0 0 1 18.048-81.6l6.592-5.12 2.368-1.536L346.112 59.904z m27.648 84.864l-92.16 50.664 1.792 5.056c4.224 13.184 7.296 27.2 8.576 41.216l0.64 14.016a192.96 192.96 0 0 1-165.632 191.104l-3.904 0.448-1.28 7.936a480 480 0 0 0-4.672 44.096l-0.32 12.992c0 16.32 2.048 36.8 5.056 56.96l1.216 7.936 3.904 0.448a192.96 192.96 0 0 1 165.312 179.584l0.384 11.52c0 18.752-3.648 37.76-9.28 55.424l-1.792 5.056 85.568 47.936 1.344-1.28c7.04-6.912 15.616-14.464 25.088-21.952l9.728-7.424c37.12-27.2 72.96-41.152 106.752-41.152 33.984 0 70.144 14.208 107.52 41.856 12.48 9.344 23.552 18.944 32.832 27.904l3.392 3.392 89.536-49.408-1.792-5.056a195.968 195.648 0 0 1-8.576-41.216l-0.64-14.08a192.96 192.96 0 0 1 165.76-191.104l3.84-0.448 1.28-8.128a480 480 0 0 0 4.672-43.904l0.32-12.864c0-16.256-1.984-36.48-4.992-56.896l-1.344-8.128-3.84-0.448a192.96 192.96 0 0 1-165.376-179.584l-0.32-11.52c0-18.88 3.712-37.952 9.28-55.488l1.728-4.992-88.384-49.024-3.072 2.944a303.36 303.36 0 0 1-23.68 19.648l-9.216 6.72c-36.288 25.6-71.296 38.72-104.064 38.72-33.088 0-68.352-13.44-104.96-39.488a325.76 325.76 0 0 1-32.64-26.496l-3.584-3.52z m136.704 188.608a178.496 178.496 0 0 1 178.24 178.24 178.432 178.432 0 0 1-178.24 178.304A178.432 178.432 0 0 1 332.16 511.616a178.496 178.496 0 0 1 178.24-178.176z m0 88c-49.792 0-90.24 40.512-90.24 90.24 0 49.792 40.448 90.304 90.24 90.304 49.792 0 90.24-40.512 90.24-90.24 0-49.792-40.448-90.304-90.24-90.304z" fill="#ffffff" p-id="1481"></path>
            </svg>
        </button>
    </nav>

    <div class="container">
        <!-- 留言提交表单 -->
        <div class="mb-8 p-6 bg-white rounded-xl shadow-md">
            <h1 class="text-2xl font-semibold text-gray-700 mb-4">发表留言</h1>
            <form id="messageForm" class="space-y-4">
                <div>
                    <label for="username" class="block text-sm font-medium text-gray-700 mb-1">用户名:</label>
                    <input type="text" id="username" class="input-field" placeholder="您的名字" required>
                </div>
                <div>
                    <label for="message" class="block text-sm font-medium text-gray-700 mb-1">留言:</label>
                    <textarea id="message" class="input-field" placeholder="写下您的留言..." required></textarea>
                </div>
                <button type="submit" class="btn btn-primary w-full">提交留言</button>
            </form>
            <p class="text-sm text-gray-600 text-center mt-4" id="currentPostingHours">当前发言时段：加载中...</p>
        </div>

        <!-- 留言列表 -->
        <div class="mb-8 p-6 bg-white rounded-xl shadow-md">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">所有留言</h2>
            <div id="messagesContainer">
                <!-- 留言将在这里动态加载 -->
                <p class="text-gray-500 text-center" id="noMessagesText">暂无留言。</p>
            </div>
        </div>

        <!-- 管理员登录 -->
        <div class="p-6 bg-white rounded-xl shadow-md">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">管理员登录</h2>
            <form id="adminLoginForm" class="space-y-4">
                <div>
                    <label for="adminPassword" class="block text-sm font-medium text-gray-700 mb-1">管理员密码:</label>
                    <input type="password" id="adminPassword" class="input-field" placeholder="输入管理员密码" required>
                </div>
                <button type="submit" class="btn btn-primary w-full">登录</button>
            </form>
            <p id="adminStatus" class="text-center mt-4 text-sm"></p>
            <button id="adminLogoutBtn" class="btn btn-danger w-full mt-4 hidden">退出管理员</button>
        </div>

        <!-- 管理员设置面板 -->
        <div class="p-6 bg-white rounded-xl shadow-md mt-6" id="adminConfigSection" style="display: none;">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">管理员面板</h2>
            <div class="flex flex-col md:flex-row gap-6">
                <!-- 左侧导航栏 -->
                <div id="adminNav" class="md:w-1/4 flex-shrink-0">
                    <button class="admin-panel-nav-btn active" data-target="postingHoursContent">发言时段设置</button>
                    <button class="admin-panel-nav-btn" data-target="ipManagementContent">IP 管理</button>
                </div>

                <!-- 右侧内容区域 -->
                <div id="adminContentArea" class="md:w-3/4 flex-grow">
                    <!-- 设置发言时段内容 -->
                    <div id="postingHoursContent" class="space-y-4 p-4 border border-gray-200 rounded-lg bg-gray-50">
                        <h3 class="text-xl font-semibold text-gray-700 mb-4">设置发言时段</h3>
                        <div>
                            <label for="setStartTime" class="block text-sm font-medium text-gray-700 mb-1">开始时间:</label>
                            <input type="datetime-local" id="setStartTime" class="input-field" required>
                        </div>
                        <div>
                            <label for="setEndTime" class="block text-sm font-medium text-gray-700 mb-1">结束时间:</label>
                            <input type="datetime-local" id="setEndTime" class="input-field" required>
                        </div>
                        <button id="savePostingHoursBtn" class="btn btn-primary w-full">保存设置</button>
                        <p id="postingHoursStatus" class="text-center mt-4 text-sm"></p>
                    </div>

                    <!-- IP 管理内容 -->
                    <div id="ipManagementContent" class="space-y-4 p-4 border border-gray-200 rounded-lg bg-gray-50 hidden">
                        <h3 class="text-xl font-semibold text-gray-700 mb-4">IP 管理</h3>
                        <div>
                            <label for="ipAddressInput" class="block text-sm font-medium text-gray-700 mb-1">IP 地址:</label>
                            <input type="text" id="ipAddressInput" class="input-field" placeholder="例如: 192.168.1.1" pattern="^([0-9]{1,3}\.){3}[0-9]{1,3}$" title="请输入有效的IPv4地址" required>
                        </div>
                        <div class="flex space-x-4">
                            <button id="banIpBtn" class="btn btn-danger w-1/2">封禁 IP</button>
                            <button id="unbanIpBtn" class="btn btn-secondary w-1/2">解封 IP</button>
                        </div>
                        <p id="ipManagementStatus" class="text-center mt-2 text-sm"></p>

                        <h4 class="text-lg font-semibold text-gray-700 mt-6 mb-2">已封禁 IP 列表:</h4>
                        <div id="bannedIpList" class="border border-gray-200 rounded-md p-3 max-h-48 overflow-y-auto">
                            <p class="text-gray-500 text-sm text-center">加载中...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Developer Info Footer -->
    <footer class="mt-8 py-4 text-center text-gray-600 text-sm bg-gray-100">
        <div class="mx-auto max-w-screen-lg px-4">
            <p>开发者信息：Mr_Onion</p>
            <p>联系邮箱：admin@mr-onion-blog.fun</p>
            <p>开发者首页：<a href="https://mr-onion-blog.fun" target="_blank" class="text-blue-600 hover:underline">Mr_Onion's Blog</a></p>
            <p class="mt-2">&copy; 2024 NSOI题目审核系统. All rights reserved.</p>
        </div>
    </footer>

    <script>
        // Cloudflare Worker URL - IMPORTANT: Replace this with your actual Cloudflare Worker URL.
        const WORKER_URL = 'https://guest.mr-onion-blog.fun'; 

        // Global state variables
        let isAdmin = false;
        let adminSessionKey = null;
        let postingStartTime;
        let postingEndTime;

        // DOM Elements
        const elements = {
            messagesContainer: document.getElementById('messagesContainer'),
            messageForm: document.getElementById('messageForm'),
            usernameInput: document.getElementById('username'),
            messageInput: document.getElementById('message'),
            adminLoginForm: document.getElementById('adminLoginForm'),
            adminPasswordInput: document.getElementById('adminPassword'),
            adminStatusText: document.getElementById('adminStatus'),
            adminLogoutBtn: document.getElementById('adminLogoutBtn'),
            noMessagesText: document.getElementById('noMessagesText'),
            adminConfigSection: document.getElementById('adminConfigSection'),
            setStartTimeInput: document.getElementById('setStartTime'),
            setEndTimeInput: document.getElementById('setEndTime'),
            savePostingHoursBtn: document.getElementById('savePostingHoursBtn'),
            postingHoursStatusText: document.getElementById('postingHoursStatus'),
            currentPostingHoursText: document.getElementById('currentPostingHours'),
            ipAddressInput: document.getElementById('ipAddressInput'),
            banIpBtn: document.getElementById('banIpBtn'),
            unbanIpBtn: document.getElementById('unbanIpBtn'),
            ipManagementStatus: document.getElementById('ipManagementStatus'),
            bannedIpListContainer: document.getElementById('bannedIpList'),
            termsModal: document.getElementById('termsModal'),
            agreeTermsBtn: document.getElementById('agreeTermsBtn'),
            hideTermsTodayCheckbox: document.getElementById('hideTermsTodayCheckbox'),
            // Elements for settings modal
            settingsModal: document.getElementById('settingsModal'),
            gearIcon: document.getElementById('gearIcon'),
            closeSettingsModalBtn: document.getElementById('closeSettingsModalBtn'),
            refreshMessagesBtn: document.getElementById('refreshMessagesBtn'),
            deleteTermsCookieBtn: document.getElementById('deleteTermsCookieBtn'),
            // New admin panel elements
            adminNav: document.getElementById('adminNav'),
            adminNavButtons: null, // Will be populated after DOMContentLoaded
            postingHoursContent: document.getElementById('postingHoursContent'),
            ipManagementContent: document.getElementById('ipManagementContent')
        };

        // --- Utility Functions ---

        /**
         * Formats a Unix timestamp into a human-readable date and time string.
         * @param {number} timestamp - The Unix timestamp.
         * @returns {string} Formatted date and time string.
         */
        function formatTimestamp(timestamp) {
            const date = new Date(timestamp);
            if (isNaN(date.getTime())) {
                return '无效时间';
            }
            return date.toLocaleString('zh-CN', {
                year: 'numeric', month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit', second: '2-digit'
            });
        }

        /**
         * Escapes HTML characters and converts newlines to <br> tags.
         * @param {string} text - The input text.
         * @returns {string} Formatted HTML string.
         */
        function formatMessageContent(text) {
            const escapedText = text.replace(/&/g, '&amp;')
                                    .replace(/</g, '&lt;')
                                    .replace(/>/g, '&gt;')
                                    .replace(/"/g, '&quot;')
                                    .replace(/'/g, '&#039;');
            return escapedText.replace(/\n/g, '<br>');
        }

        /**
         * Gets the current date formatted as YYYY-MM-DD.
         * @returns {string} Current date string.
         */
        function getCurrentDateFormatted() {
            const now = new Date();
            const year = now.getFullYear();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const day = now.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        /**
         * Checks if the current time is within the allowed posting hours.
         * @returns {boolean} True if within hours, false otherwise.
         */
        function isCurrentTimeWithinHours() {
            if (!postingStartTime || !postingEndTime) {
                console.warn("Posting times not set, assuming always allowed.");
                return true;
            }
            const now = new Date();
            const start = new Date(postingStartTime);
            const end = new Date(postingEndTime);
            if (isNaN(start.getTime()) || isNaN(end.getTime())) {
                console.error("Invalid posting time configuration.");
                return true;
            }
            return now.getTime() >= start.getTime() && now.getTime() <= end.getTime();
        }

        /**
         * Displays a custom alert modal.
         * @param {string} message - The message to display.
         */
        function showCustomAlert(message) {
            const modalHtml = `
                <div id="customAlertModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
                        <p class="text-lg text-gray-800 mb-4">${message}</p>
                        <button id="customAlertCloseBtn" class="btn btn-primary w-full">确定</button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            document.getElementById('customAlertCloseBtn').addEventListener('click', () => {
                document.getElementById('customAlertModal').remove();
            });
        }

        /**
         * Displays a custom confirmation modal.
         * @param {string} message - The message to display.
         * @param {Function} onConfirm - Callback function if user confirms.
         */
        function showCustomConfirm(message, onConfirm) {
            const modalHtml = `
                <div id="customConfirmModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
                        <p class="text-lg text-gray-800 mb-4">${message}</p>
                        <div class="flex justify-end space-x-3">
                            <button id="customConfirmCancelBtn" class="btn btn-secondary">取消</button>
                            <button id="customConfirmOkBtn" class="btn btn-danger">确定</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            document.getElementById('customConfirmOkBtn').addEventListener('click', () => {
                onConfirm();
                document.getElementById('customConfirmModal').remove();
            });
            document.getElementById('customConfirmCancelBtn').addEventListener('click', () => {
                document.getElementById('customConfirmModal').remove();
            });
        }

        // --- Cookie Handling Functions ---
        /**
         * Sets a cookie.
         * @param {string} name - The name of the cookie.
         * @param {string} value - The value of the cookie.
         * @param {number} days - The number of days until the cookie expires.
         */
        function setCookie(name, value, days) {
            let expires = "";
            if (days) {
                const date = new Date();
                date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                expires = "; expires=" + date.toUTCString();
            }
            document.cookie = name + "=" + (value || "")  + expires + "; path=/";
        }

        /**
         * Gets a cookie by name.
         * @param {string} name - The name of the cookie.
         * @returns {string|null} The cookie value, or null if not found.
         */
        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for(let i=0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
        }

        /**
         * Erases a cookie by name.
         * @param {string} name - The name of the cookie.
         */
        function eraseCookie(name) {
            document.cookie = name + '=; Max-Age=-99999999;';
        }


        // --- API Interaction Functions ---

        /**
         * Fetches messages from the backend.
         * @returns {Promise<Array>} List of messages.
         */
        async function fetchMessages() {
            try {
                let response;
                if (isAdmin && adminSessionKey) {
                    response = await fetch(`${WORKER_URL}/admin/messages-with-ip`, {
                        headers: { 'X-Admin-Session': adminSessionKey }
                    });
                } else {
                    response = await fetch(`${WORKER_URL}/messages`);
                }
                
                if (!response.ok) {
                    if (response.status === 401 && isAdmin) {
                        showCustomAlert('管理员会话已过期或无效，请重新登录。');
                        adminLogout();
                        return [];
                    }
                    const errorText = await response.text();
                    throw new Error(`HTTP Error! Status: ${response.status}, Message: ${errorText}`);
                }
                const rawMessages = await response.json();
                return rawMessages.filter(msg => typeof msg === 'object' && msg !== null && typeof msg.id === 'string');
            } catch (error) {
                console.error('Failed to fetch messages:', error);
                elements.messagesContainer.innerHTML = `<p class="text-red-500 text-center">加载留言失败。</p>`;
                return [];
            }
        }

        /**
         * Fetches application configuration (posting hours) from the backend.
         */
        async function fetchConfig() {
            try {
                const response = await fetch(`${WORKER_URL}/config`);
                if (!response.ok) {
                    throw new Error(`HTTP Error! Status: ${response.status}`);
                }
                const config = await response.json();
                postingStartTime = config.postingStartTime;
                postingEndTime = config.postingEndTime;
                updatePostingHoursDisplay();
                if (isAdmin) {
                    elements.setStartTimeInput.value = postingStartTime;
                    elements.setEndTimeInput.value = postingEndTime;
                }
            }
            catch (error) {
                console.error('Failed to fetch config:', error);
                elements.postingHoursStatusText.textContent = 'Failed to fetch posting hours.';
                elements.postingHoursStatusText.className = 'text-center mt-4 text-sm text-red-600';
                // Fallback to default full day if config fetch fails
                postingStartTime = `${getCurrentDateFormatted()}T00:00`;
                postingEndTime = `${getCurrentDateFormatted()}T23:59`;
                updatePostingHoursDisplay(); 
            }
        }

        /**
         * Sends a message to the backend.
         * @param {string} username - The message author's username.
         * @param {string} message - The message content.
         */
        async function postMessage(username, message) {
            try {
                const headers = { 'Content-Type': 'application/json' };
                let bodyData = { username, message };

                if (isAdmin && adminSessionKey) {
                    headers['X-Admin-Session'] = adminSessionKey;
                    bodyData.isAdminMessage = true;
                }

                const response = await fetch(`${WORKER_URL}/messages`, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(bodyData),
                });

                if (!response.ok) {
                    if (response.status === 401 && isAdmin) {
                        showCustomAlert('管理员会话已过期或无效，请重新登录。');
                        adminLogout();
                        return;
                    }
                    const errorText = await response.text();
                    throw new Error(`HTTP Error! Status: ${response.status}, Message: ${errorText}`);
                }
                elements.usernameInput.value = '';
                elements.messageInput.value = '';
                await updateUI(); // Refresh UI after successful post
            } catch (error) {
                console.error('Failed to submit message:', error);
                showCustomAlert('Failed to submit message. ' + (error.message || ''));
            }
        }

        /**
         * Deletes a message.
         * @param {string} id - The ID of the message to delete.
         */
        async function deleteMessage(id) {
            try {
                const response = await fetch(`${WORKER_URL}/messages/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Admin-Session': adminSessionKey,
                    },
                });

                if (!response.ok) {
                    if (response.status === 401 && isAdmin) {
                        showCustomAlert('管理员会话已过期或无效，请重新登录。');
                        adminLogout();
                        return;
                    }
                    const errorText = await response.text();
                    throw new Error(`HTTP Error! Status: ${response.status}, Message: ${errorText}`);
                }
                await updateUI(); // Refresh UI
            } catch (error) {
                console.error('Failed to delete message:', error);
                showCustomAlert('Failed to delete message. ' + (error.message || ''));
            }
        }

        /**
         * Adds a reply to a message.
         * @param {string} messageId - The ID of the message to reply to.
         * @param {string} username - The reply author's username.
         * @param {string} replyMessage - The reply content.
         * @param {boolean} isAdminReply - True if the reply is from an admin.
         */
        async function addReply(messageId, username, replyMessage, isAdminReply) {
            try {
                const headers = { 'Content-Type': 'application/json' };
                if (isAdminReply && adminSessionKey) {
                    headers['X-Admin-Session'] = adminSessionKey;
                }
                const response = await fetch(`${WORKER_URL}/messages/${messageId}/replies`, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({ username, message: replyMessage, isAdminReply }),
                });

                if (!response.ok) {
                    if (response.status === 401 && isAdmin) {
                        showCustomAlert('管理员会话已过期或无效，请重新登录。');
                        adminLogout();
                        return;
                    }
                    const errorText = await response.text();
                    throw new Error(`HTTP Error! Status: ${response.status}, Message: ${errorText}`);
                }
                // Hide form and clear content
                document.getElementById(`replyFormContainer-${messageId}`).classList.add('hidden');
                document.getElementById(`replyUsername-${messageId}`).value = isAdmin ? '管理员' : '';
                document.getElementById(`replyMessage-${messageId}`).value = '';
                await updateUI(); // Refresh UI
            } catch (error) {
                console.error('Failed to add reply:', error);
                showCustomAlert('Failed to add reply. ' + (error.message || ''));
            }
        }

        /**
         * Toggles the pinned status of a message.
         * @param {string} messageId - The ID of the message.
         * @param {boolean} isPinned - The new pinned status.
         */
        async function togglePinMessage(messageId, isPinned) {
            try {
                const payload = { id: messageId, isPinned: isPinned };
                const response = await fetch(`${WORKER_URL}/admin/pin-message`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Admin-Session': adminSessionKey,
                    },
                    body: JSON.stringify(payload),
                });

                if (!response.ok) {
                    if (response.status === 401 && isAdmin) {
                        showCustomAlert('管理员会话已过期或无效，请重新登录。');
                        adminLogout();
                        return;
                    }
                    const errorText = await response.text();
                    throw new Error(`HTTP Error! Status: ${response.status}, Message: ${errorText}`);
                }
                const result = await response.json();
                if (result.success) {
                    showCustomAlert(`留言 ${messageId} 已${isPinned ? '置顶' : '取消置顶'}。`);
                    await updateUI(); // Refresh UI
                } else {
                    showCustomAlert(`操作失败: ${result.message || '未知错误'}`);
                }
            } catch (error) {
                console.error('Failed to toggle pin status:', error);
                showCustomAlert('操作失败。' + (error.message || ''));
            }
        }

        /**
         * Fetches the list of banned IP addresses.
         * @returns {Promise<Array>} List of banned IPs.
         */
        async function fetchBannedIps() {
            if (!isAdmin || !adminSessionKey) {
                elements.bannedIpListContainer.innerHTML = '<p class="text-gray-500 text-sm text-center">请登录管理员账户以查看封禁IP列表。</p>';
                return [];
            }
            try {
                elements.bannedIpListContainer.innerHTML = '<p class="text-gray-500 text-sm text-center">加载中...</p>';
                const response = await fetch(`${WORKER_URL}/admin/banned-ips`, {
                    headers: { 'X-Admin-Session': adminSessionKey }
                });
                if (!response.ok) {
                    if (response.status === 401 && isAdmin) {
                        showCustomAlert('管理员会话已过期或无效，请重新登录。');
                        adminLogout();
                        return [];
                    }
                    throw new Error(`HTTP Error! Status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error('Failed to fetch banned IPs:', error);
                elements.bannedIpListContainer.innerHTML = `<p class="text-red-500 text-center text-sm">加载封禁IP失败。</p>`;
                return [];
            }
        }

        /**
         * Bans an IP address.
         * @param {string} ip - The IP address to ban.
         */
        async function banIp(ip) {
            try {
                const response = await fetch(`${WORKER_URL}/admin/ban-ip`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Admin-Session': adminSessionKey,
                    },
                    body: JSON.stringify({ ip }),
                });

                if (!response.ok) {
                    if (response.status === 401 && isAdmin) {
                        showCustomAlert('管理员会话已过期或无效，请重新登录。');
                        adminLogout();
                        return;
                    }
                    const errorText = await response.text();
                    throw new Error(`HTTP Error! Status: ${response.status}, Message: ${errorText}`);
                }
                const result = await response.json();
                if (result.success) {
                    elements.ipManagementStatus.textContent = `IP ${ip} 封禁成功！`;
                    elements.ipManagementStatus.className = 'text-center mt-2 text-sm text-green-600';
                    elements.ipAddressInput.value = '';
                    await renderBannedIpsList(); // Re-render banned IP list
                } else {
                    elements.ipManagementStatus.textContent = `封禁 IP 失败: ${result.message || '未知错误'}`;
                    elements.ipManagementStatus.className = 'text-center mt-2 text-sm text-red-600';
                }
            } catch (error) {
                console.error('Failed to ban IP:', error);
                elements.ipManagementStatus.textContent = '封禁 IP 请求失败。' + (error.message || '');
                elements.ipManagementStatus.className = 'text-center mt-2 text-sm text-red-600';
            }
        }

        /**
         * Unbans an IP address.
         * @param {string} ip - The IP address to unban.
         */
        async function unbanIp(ip) {
            try {
                const response = await fetch(`${WORKER_URL}/admin/unban-ip`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Admin-Session': adminSessionKey,
                    },
                    body: JSON.stringify({ ip }),
                });

                if (!response.ok) {
                    if (response.status === 401 && isAdmin) {
                        showCustomAlert('管理员会话已过期或无效，请重新登录。');
                        adminLogout();
                        return;
                    }
                    const errorText = await response.text();
                    throw new Error(`HTTP Error! Status: ${response.status}, Message: ${errorText}`);
                }
                const result = await response.json();
                if (result.success) {
                    elements.ipManagementStatus.textContent = `IP ${ip} 解封成功！`;
                    elements.ipManagementStatus.className = 'text-center mt-2 text-sm text-green-600';
                    await renderBannedIpsList(); // Re-render banned IP list
                } else {
                    elements.ipManagementStatus.textContent = `解封 IP 失败: ${result.message || '未知错误'}`;
                    elements.ipManagementStatus.className = 'text-center mt-2 text-sm text-red-600';
                }
            } catch (error) {
                console.error('Failed to unban IP:', error);
                elements.ipManagementStatus.textContent = '解封 IP 请求失败。' + (error.message || '');
                elements.ipManagementStatus.className = 'text-center mt-2 text-sm text-red-600';
            }
        }

        // --- UI Rendering Functions ---

        /**
         * Renders the list of messages.
         * @param {Array} messages - The array of message objects.
         */
        function renderMessages(messages) {
            elements.messagesContainer.innerHTML = '';
            if (messages.length === 0) {
                elements.noMessagesText.style.display = 'block';
            } else {
                elements.noMessagesText.style.display = 'none';
                messages.forEach(msg => {
                    const messageCard = document.createElement('div');
                    messageCard.className = 'message-card';
                    messageCard.innerHTML = `
                        <div class="message-header">
                            <div class="message-content-main">
                                <p class="text-lg font-semibold text-gray-900">
                                    ${msg.username ?? '匿名用户'}
                                    ${msg.isAdminMessage ? '<span class="admin-message-badge">管理员</span>' : ''}
                                    ${msg.isPinned ? '<span class="pinned-badge">置顶</span>' : ''}
                                </p>
                                <p class="text-gray-700 mt-1">${formatMessageContent(msg.message ?? '无内容')}</p>
                                <p class="text-xs text-gray-500 mt-2">发表于: ${formatTimestamp(msg.timestamp ?? 0)}</p>
                                ${isAdmin && msg.senderIp ? `<p class="text-xs text-gray-400 mt-1">IP: ${msg.senderIp}</p>` : ''}
                            </div>
                            ${isAdmin ? `
                                <div class="admin-controls">
                                    <button class="btn btn-danger text-sm delete-btn" data-id="${msg.id}">删除</button>
                                    <button class="btn btn-info text-sm pin-toggle-btn" data-id="${msg.id}" data-pinned="${msg.isPinned ? 'true' : 'false'}">
                                        ${msg.isPinned ? '取消置顶' : '置顶'}
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                        <div class="replies-container w-full">
                            <h4 class="text-md font-semibold text-gray-700 mb-2">回复:</h4>
                            <div class="replies-list-${msg.id}">
                                ${msg.replies && msg.replies.length > 0 ?
                                    msg.replies.map(reply => `
                                        <div class="reply-card">
                                            <p class="font-medium text-gray-800">
                                                ${reply.username ?? '匿名用户'}
                                                ${reply.isAdminReply ? '<span class="admin-reply-badge">管理员回复</span>' : ''}
                                            </p>
                                            <p class="text-gray-700">${formatMessageContent(reply.message ?? '无内容')}</p>
                                            <p class="text-xs text-gray-500 mt-1">${formatTimestamp(reply.timestamp ?? 0)}</p>
                                        </div>
                                    `).join('')
                                    : '<p class="text-gray-500 text-sm">暂无回复。</p>'
                                }
                            </div>
                            <button class="btn btn-secondary text-sm mt-3 toggle-reply-form" data-id="${msg.id}">回复</button>
                            <div class="reply-form-container hidden mt-3" id="replyFormContainer-${msg.id}">
                                <h5 class="text-md font-semibold text-gray-700 mb-2">添加回复:</h5>
                                <form class="reply-form" data-id="${msg.id}">
                                    <div>
                                        <label for="replyUsername-${msg.id}" class="block text-sm font-medium text-gray-700 mb-1">用户名:</label>
                                        <input type="text" id="replyUsername-${msg.id}" class="input-field" placeholder="您的名字" value="${isAdmin ? '管理员' : ''}" required>
                                    </div>
                                    <div>
                                        <label for="replyMessage-${msg.id}" class="block text-sm font-medium text-gray-700 mb-1">回复内容:</label>
                                        <textarea id="replyMessage-${msg.id}" class="input-field" placeholder="写下您的回复..." required></textarea>
                                    </div>
                                    <button type="submit" class="btn btn-primary w-full">提交回复</button>
                                </form>
                            </div>
                        </div>
                    `;
                    elements.messagesContainer.appendChild(messageCard);
                });
                setupMessageEventListeners();
            }
        }

        /**
         * Renders the list of banned IP addresses.
         * @param {Array} ips - The array of banned IP strings.
         */
        function renderBannedIps(ips) {
            elements.bannedIpListContainer.innerHTML = '';
            if (ips.length === 0) {
                elements.bannedIpListContainer.innerHTML = '<p class="text-gray-500 text-sm text-center">暂无封禁IP。</p>';
            } else {
                ips.forEach(ip => {
                    const ipItem = document.createElement('div');
                    ipItem.className = 'banned-ip-item';
                    ipItem.innerHTML = `
                        <span class="text-gray-800">${ip}</span>
                        <button class="btn btn-secondary text-xs unban-ip-btn" data-ip="${ip}">解封</button>
                    `;
                    elements.bannedIpListContainer.appendChild(ipItem);
                });
                setupBannedIpEventListeners();
            }
        }

        /**
         * Updates the display of current posting hours.
         */
        function updatePostingHoursDisplay() {
            const defaultFullStartTime = `${getCurrentDateFormatted()}T00:00`;
            const defaultFullEndTime = `${getCurrentDateFormatted()}T23:59`;

            if (postingStartTime === defaultFullStartTime && postingEndTime === defaultFullEndTime) {
                elements.currentPostingHoursText.textContent = '当前发言时段：全天开放';
            } else {
                const startDisplay = new Date(postingStartTime).toLocaleString('zh-CN', {
                    year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'
                });
                const endDisplay = new Date(postingEndTime).toLocaleString('zh-CN', {
                    year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'
                });
                elements.currentPostingHoursText.textContent = `当前发言时段：${startDisplay} ~ ${endDisplay}`;
            }
        }

        /**
         * Shows the terms and conditions modal.
         */
        function showTermsModal() {
            elements.termsModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden'; // Disable scrolling on body
        }

        /**
         * Hides the terms and conditions modal.
         */
        function hideTermsModal() {
            elements.termsModal.classList.add('hidden');
            document.body.style.overflow = ''; // Re-enable scrolling on body
        }

        /**
         * Shows the settings modal.
         */
        function showSettingsModal() {
            elements.settingsModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden'; // Disable scrolling on body
        }

        /**
         * Hides the settings modal.
         */
        function hideSettingsModal() {
            elements.settingsModal.classList.add('hidden');
            document.body.style.overflow = ''; // Re-enable scrolling on body
        }

        /**
         * Shows a specific admin content section and updates active nav button.
         * @param {string} sectionId - The ID of the content section to show (e.g., 'postingHoursContent').
         */
        function showAdminSection(sectionId) {
            // Hide all content sections
            elements.postingHoursContent.classList.add('hidden');
            elements.ipManagementContent.classList.add('hidden');

            // Remove 'active' class from all nav buttons
            elements.adminNavButtons.forEach(btn => btn.classList.remove('active'));

            // Show the selected content section
            document.getElementById(sectionId).classList.remove('hidden');
            // Add 'active' class to the corresponding nav button
            document.querySelector(`.admin-panel-nav-btn[data-target="${sectionId}"]`).classList.add('active');
        }

        // --- Event Handlers ---

        /**
         * Handles message form submission.
         * @param {Event} e - The submit event.
         */
        async function handleMessageSubmit(e) {
            e.preventDefault();
            const username = elements.usernameInput.value;
            const message = elements.messageInput.value;

            if (!isAdmin && !isCurrentTimeWithinHours()) {
                const startDisplay = new Date(postingStartTime).toLocaleString('zh-CN', {
                    year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'
                });
                const endDisplay = new Date(postingEndTime).toLocaleString('zh-CN', {
                    year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'
                });
                showCustomAlert(`当前不在允许的发言时段内。发言时段：${startDisplay} ~ ${endDisplay}`);
                return;
            }
            await postMessage(username, message);
        }

        /**
         * Handles admin login form submission.
         * @param {Event} e - The submit event.
         */
        async function handleAdminLogin(e) {
            e.preventDefault();
            const password = elements.adminPasswordInput.value;

            try {
                const response = await fetch(`${WORKER_URL}/admin/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password }),
                });

                if (!response.ok) {
                    throw new Error(`HTTP Error! Status: ${response.status}`);
                }
                const result = await response.json();
                if (result.success) {
                    isAdmin = true;
                    adminSessionKey = result.sessionKey;
                    localStorage.setItem('isAdmin', 'true');
                    localStorage.setItem('adminSessionKey', adminSessionKey);
                    elements.adminStatusText.textContent = '登录成功！';
                    elements.adminStatusText.className = 'text-center mt-4 text-sm text-green-600';
                    elements.adminLogoutBtn.classList.remove('hidden');
                    elements.adminLoginForm.classList.add('hidden');
                    elements.adminConfigSection.style.display = 'block';
                    showAdminSection('postingHoursContent'); // Show default admin section
                    await updateUI(); // Refresh UI after login
                } else {
                    isAdmin = false;
                    adminSessionKey = null;
                    localStorage.setItem('isAdmin', 'false');
                    localStorage.removeItem('adminSessionKey');
                    elements.adminStatusText.textContent = '密码错误。';
                    elements.adminStatusText.className = 'text-center mt-4 text-sm text-red-600';
                }
            } catch (error) {
                console.error('Admin login failed:', error);
                elements.adminStatusText.textContent = '登录请求失败。';
                elements.adminStatusText.className = 'text-center mt-4 text-sm text-red-600';
            } finally {
                elements.adminPasswordInput.value = '';
            }
        }

        /**
         * Handles admin logout.
         */
        function adminLogout() {
            isAdmin = false;
            adminSessionKey = null;
            localStorage.removeItem('isAdmin');
            localStorage.removeItem('adminSessionKey');
            elements.adminStatusText.textContent = '已退出。';
            elements.adminStatusText.className = 'text-center mt-4 text-sm text-gray-600';
            elements.adminLogoutBtn.classList.add('hidden');
            elements.adminLoginForm.classList.remove('hidden');
            elements.adminConfigSection.style.display = 'none';
            updateUI(); // Refresh UI
        }

        /**
         * Handles saving posting hours settings.
         */
        async function handleSavePostingHours() {
            const startTime = elements.setStartTimeInput.value;
            const endTime = elements.setEndTimeInput.value;

            if (!startTime || !endTime) {
                elements.postingHoursStatusText.textContent = '请填写开始时间和结束时间。';
                elements.postingHoursStatusText.className = 'text-center mt-4 text-sm text-red-600';
                return;
            }

            try {
                const response = await fetch(`${WORKER_URL}/config`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Admin-Session': adminSessionKey,
                    },
                    body: JSON.stringify({ postingStartTime: startTime, postingEndTime: endTime }),
                });

                if (!response.ok) {
                    if (response.status === 401 && isAdmin) {
                        showCustomAlert('管理员会话已过期或无效，请重新登录。');
                        adminLogout();
                        return;
                    }
                    const errorText = await response.text();
                    throw new Error(`HTTP Error! Status: ${response.status}, Message: ${errorText}`);
                }
                const result = await response.json();
                if (result.success) {
                    elements.postingHoursStatusText.textContent = '发言时段设置成功！';
                    elements.postingHoursStatusText.className = 'text-center mt-4 text-sm text-green-600';
                    await fetchConfig(); // Refresh posting hours display
                } else {
                    elements.postingHoursStatusText.textContent = '设置失败。';
                    elements.postingHoursStatusText.className = 'text-center mt-4 text-sm text-red-600';
                }
            } catch (error) {
                console.error('Failed to save posting hours:', error);
                elements.postingHoursStatusText.textContent = '保存发言时段失败。请检查网络连接或后端服务是否正常运行。' + (error.message || '');
                elements.postingHoursStatusText.className = 'text-center mt-4 text-sm text-red-600';
            }
        }

        /**
         * Handles banning an IP address.
         */
        async function handleBanIp() {
            const ip = elements.ipAddressInput.value.trim();
            if (!ip || !elements.ipAddressInput.checkValidity()) {
                elements.ipManagementStatus.textContent = elements.ipAddressInput.title || '请输入有效的IP地址。';
                elements.ipManagementStatus.className = 'text-center mt-2 text-sm text-red-600';
                return;
            }
            await banIp(ip);
        }

        /**
         * Handles unbanning an IP address.
         */
        async function handleUnbanIp() {
            const ip = elements.ipAddressInput.value.trim();
            if (!ip || !elements.ipAddressInput.checkValidity()) {
                elements.ipManagementStatus.textContent = elements.ipAddressInput.title || '请输入有效的IP地址。';
                elements.ipManagementStatus.className = 'text-center mt-2 text-sm text-red-600';
                return;
            }
            await unbanIp(ip);
        }

        /**
         * Handles refreshing messages.
         */
        async function handleRefreshMessages() {
            console.log('Refreshing messages...');
            await updateUI();
            showCustomAlert('留言已刷新。');
            hideSettingsModal(); // Close settings modal after refresh
        }

        /**
         * Handles deleting the "hideTermsToday" cookie.
         */
        function handleDeleteTermsCookie() {
            eraseCookie('hideTermsToday');
            showCustomAlert('“今日不再显示”Cookie 已删除。下次访问将再次显示使用须知。');
            hideSettingsModal(); // Close settings modal after deleting cookie
            showTermsModal(); // Re-show the terms modal immediately
        }

        // --- Event Listener Setup Functions ---

        /**
         * Sets up event listeners for message-related buttons (delete, pin/unpin, reply).
         */
        function setupMessageEventListeners() {
            if (isAdmin) {
                document.querySelectorAll('.delete-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const messageId = e.target.dataset.id;
                        showCustomConfirm('确定要删除这条留言吗？', async () => {
                            await deleteMessage(messageId);
                        });
                    });
                });
                document.querySelectorAll('.pin-toggle-btn').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const messageId = e.target.dataset.id;
                        const isCurrentlyPinned = e.target.dataset.pinned === 'true';
                        await togglePinMessage(messageId, !isCurrentlyPinned);
                    });
                });
            }
            document.querySelectorAll('.toggle-reply-form').forEach(button => {
                button.addEventListener('click', (e) => {
                    const messageId = e.target.dataset.id;
                    const replyFormContainer = document.getElementById(`replyFormContainer-${messageId}`);
                    replyFormContainer.classList.toggle('hidden');
                    if (isAdmin) {
                        document.getElementById(`replyUsername-${messageId}`).value = '管理员';
                    }
                });
            });
            document.querySelectorAll('.reply-form').forEach(form => {
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const messageId = e.target.dataset.id;
                    const replyUsername = document.getElementById(`replyUsername-${messageId}`).value;
                    const replyMessage = document.getElementById(`replyMessage-${messageId}`).value;
                    await addReply(messageId, replyUsername, replyMessage, isAdmin);
                });
            });
        }

        /**
         * Sets up event listeners for banned IP list buttons.
         */
        function setupBannedIpEventListeners() {
            document.querySelectorAll('.unban-ip-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const ipToUnban = e.target.dataset.ip;
                    showCustomConfirm(`确定要解封 IP: ${ipToUnban} 吗？`, async () => {
                        await unbanIp(ipToUnban);
                    });
                });
            });
        }

        /**
         * Attaches all primary event listeners.
         */
        function attachGlobalEventListeners() {
            elements.messageForm.addEventListener('submit', handleMessageSubmit);
            elements.adminLoginForm.addEventListener('submit', handleAdminLogin);
            elements.adminLogoutBtn.addEventListener('click', adminLogout);
            elements.savePostingHoursBtn.addEventListener('click', handleSavePostingHours);
            elements.banIpBtn.addEventListener('click', handleBanIp);
            elements.unbanIpBtn.addEventListener('click', handleUnbanIp);
            elements.agreeTermsBtn.addEventListener('click', handleTermsAgreement);
            
            // Settings modal event listeners
            elements.gearIcon.addEventListener('click', showSettingsModal);
            elements.closeSettingsModalBtn.addEventListener('click', hideSettingsModal);
            elements.settingsModal.addEventListener('click', (e) => {
                // Close modal if clicked on overlay, not on content
                if (e.target === elements.settingsModal) {
                    hideSettingsModal();
                }
            });
            elements.refreshMessagesBtn.addEventListener('click', handleRefreshMessages);
            elements.deleteTermsCookieBtn.addEventListener('click', handleDeleteTermsCookie);

            // Admin panel navigation event listeners
            elements.adminNavButtons = elements.adminNav.querySelectorAll('.admin-panel-nav-btn');
            elements.adminNavButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    const targetSectionId = e.target.dataset.target;
                    showAdminSection(targetSectionId);
                });
            });
        }

        // --- Core Application Logic ---

        /**
         * Performs a full UI update by fetching latest data and re-rendering.
         */
        async function updateUI() {
            const messages = await fetchMessages();
            renderMessages(messages);
            await fetchConfig();
            if (isAdmin) {
                const bannedIps = await fetchBannedIps();
                renderBannedIps(bannedIps);
            }
            updateAdminSectionVisibility();
        }

        /**
         * Updates the visibility of admin-only sections based on isAdmin status.
         */
        function updateAdminSectionVisibility() {
            if (isAdmin) {
                elements.adminStatusText.textContent = '已登录为管理员。';
                elements.adminStatusText.className = 'text-center mt-4 text-sm text-green-600';
                elements.adminLogoutBtn.classList.remove('hidden');
                elements.adminLoginForm.classList.add('hidden');
                elements.adminConfigSection.style.display = 'block';
                // Ensure a default section is shown when admin panel becomes visible
                showAdminSection('postingHoursContent'); 
            } else {
                elements.adminStatusText.textContent = '未登录管理员。';
                elements.adminStatusText.className = 'text-center mt-4 text-sm text-gray-600';
                elements.adminLogoutBtn.classList.add('hidden');
                elements.adminLoginForm.classList.remove('hidden');
                elements.adminConfigSection.style.display = 'none';
            }
        }

        /**
         * Handles the user agreeing to terms.
         */
        function handleTermsAgreement() {
            if (elements.hideTermsTodayCheckbox.checked) {
                setCookie('hideTermsToday', 'true', 1); // Set cookie for 1 day
            } else {
                eraseCookie('hideTermsToday'); // Ensure cookie is not set if unchecked
            }
            hideTermsModal();
            initializeGuestbook();
        }

        /**
         * Initializes the guestbook application.
         * Checks admin status, fetches data, and sets up UI.
         */
        function initializeGuestbook() {
            isAdmin = localStorage.getItem('isAdmin') === 'true';
            adminSessionKey = localStorage.getItem('adminSessionKey');
            if (!isAdmin || !adminSessionKey) {
                isAdmin = false;
                adminSessionKey = null;
                localStorage.removeItem('isAdmin');
                localStorage.removeItem('adminSessionKey');
            }
            
            updateUI();
        }

        // --- Initial Load Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            attachGlobalEventListeners(); // Ensure all event listeners are attached on DOMContentLoaded

            const hideTermsToday = getCookie('hideTermsToday');
            if (!hideTermsToday) {
                showTermsModal();
            } else {
                initializeGuestbook();
            }
        });
    </script>
</body>
</html>
